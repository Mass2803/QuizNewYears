<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ‰ New Year Party ğŸ‰</title>

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #111;
    color: #fff;
    padding: 20px;
  }
  button {
    padding: 15px 25px;
    margin: 10px;
    font-size: 18px;
    cursor: pointer;
  }
  .hidden {
    display: none;
  }
</style>
</head>

<body>

<h1>ğŸ‰ New Year Party ğŸ‰</h1>

<!-- ROLE SELECTION -->
<div id="roleScreen">
  <h2>Choose your role</h2>
  <button onclick="setRole('master')">ğŸ¤ Quiz Master</button>
  <button onclick="setRole('player')">ğŸ™‹ Player</button>
</div>

<!-- VOTING SCREEN -->
<div id="voteScreen" class="hidden">
  <h2>Vote: What should we do?</h2>
  <button onclick="vote('Quiz')">ğŸ§  Quiz</button>
  <button onclick="vote('Games')">ğŸ® Games</button>
  <button onclick="vote('Music')">ğŸµ Music</button>
  <p id="voteMsg"></p>
</div>

<!-- MASTER CONTROLS -->
<div id="masterScreen" class="hidden">
  <h2>Live Votes</h2>
  <div id="results"></div>
  <button onclick="endVote()">â± TIMEâ€™S UP</button>
</div>

<!-- QUIZ SCREEN -->
<div id="quizScreen" class="hidden">
  <h2>Quiz Time!</h2>
  <p id="question">2 + 2 = ?</p>
  <button onclick="answer(4)">4</button>
  <button onclick="answer(3)">3</button>
  <button onclick="answer(5)">5</button>
  <button onclick="answer(22)">22</button>
  <p id="quizMsg"></p>
</div>

<script>
/* ğŸ”´ PASTE YOUR APPS SCRIPT /exec URL HERE ğŸ”´ */
const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgt08pCLYUrLaFRv-ehEfrma9chf3Sa6jvvtkHgGCB7j6HoEnxvoxh6mPVYD45DYjDO9R8nEo847zMxarp9GGSiRk60acKmldGDEyRhJG7O4VsvK_0YSUasFkbmsG3tt8EfEBdQXMuuIBltgK_bdKz7ZdSjDGdy2ReSFy4sAfH6mUwRDWHZJPypmT69EVbxoahE71YlGSgFEr4rDA3xREll6MrjXCuagSD1D2Uozo3m0mfTHk7newDsxfES7tYa3NkZOwlorKoy230o2HcvvkLg1nrUbeOCiMmANOGv&lib=MPKv64G8uSqh63gOMII5c4Ng4AQptJ_cO";

/* unique device id */
if (!localStorage.deviceId) {
  localStorage.deviceId = Math.random().toString(36).substring(2);
}
const deviceId = localStorage.deviceId;

/* role handling */
function setRole(role) {
  localStorage.role = role;
  document.getElementById("roleScreen").classList.add("hidden");
  document.getElementById("voteScreen").classList.remove("hidden");

  if (role === "master") {
    document.getElementById("masterScreen").classList.remove("hidden");
  }
}

/* vote */
function vote(option) {
  if (localStorage.voted) {
    document.getElementById("voteMsg").innerText = "You already voted!";
    return;
  }

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      type: "vote",
      option: option
    })
  });

  localStorage.voted = "true";
  document.getElementById("voteMsg").innerText = "Vote submitted ğŸ‰";
}

/* end vote */
function endVote() {
  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      type: "setMode",
      mode: "quiz"
    })
  });
}

/* quiz answer */
function answer(value) {
  if (localStorage.answered) return;

  if (value === 4) {
    fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: "score",
        device: deviceId,
        score: 1
      })
    });
    document.getElementById("quizMsg").innerText = "âœ… Correct!";
  } else {
    document.getElementById("quizMsg").innerText = "âŒ Wrong!";
  }

  localStorage.answered = "true";
}

/* poll backend every 2 seconds */
function poll() {
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {

      /* update live votes */
      let html = "";
      for (let k in data.votes) {
        html += `<p>${k}: ${data.votes[k]}</p>`;
      }
      document.getElementById("results").innerHTML = html;

      /* switch everyone to quiz */
      if (data.mode === "quiz") {
        document.getElementById("voteScreen").classList.add("hidden");
        document.getElementById("masterScreen").classList.add("hidden");
        document.getElementById("quizScreen").classList.remove("hidden");
      }
    });
